<link rel="import" href="../polymer/polymer-element.html">

<link rel="import" href="../paper-fab/paper-fab.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../app-layout/app-layout.html">
<link rel="import" href="../app-layout/app-toolbar/app-toolbar.html">

<link rel="import" href="dory-sam-editor.html">
<link rel="import" href="dory-sam-list.html">

<dom-module id="dory-sam">
  <template>
    <style>
      :host {
        display: block;

      }

      app-toolbar {
        background-color: #4285f4;
        color: #fff;
      }

      .logo{
        padding: 10px;
        text-align: center;
      }

      paper-fab {
        right: 30px;
        bottom: 28px;
        position: fixed;
        z-index: 10;
        --paper-fab-background: var(--primary-color);
      }

      .search{
        padding : 10px;
      }
    </style>

    <iron-ajax auto id="request" url="http://localhost:9200/sam/sam/_search" handle-as="json"
               content-type="application/json" body="[[queryBody]]" method="post"
              on-response="_handleResponse"></iron-ajax>

    <app-drawer-layout>
      <app-drawer opened slot="drawer">
        <div class="logo">
          <img src="../imgs/agrica.png" alt="Agrica">
        </div>
        <div class="search">
          <paper-input value="{{searchText}}"  placeholder="Application">
            <paper-icon-button slot="suffix" icon="search" on-tap="search"></paper-icon-button>
          </paper-input>
        </div>
      </app-drawer>

      <app-header-layout>
        <app-header slot="header">
          <app-toolbar>
            <div main-title>DORY - Cartographie des Applications Agrica</div>
          </app-toolbar>
        </app-header>
      </app-header-layout>

      <div>
        <template is="dom-if" if="[[listData]]">
          <dory-sam-list items="[[listData]]"></dory-sam-list>
        </template>
      </div>
    </app-drawer-layout>



  </template>

  <script>
    /**
     * `dory-sam`
     *
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class DorySam extends Polymer.Element {
      static get is() { return 'dory-sam'; }
      static get properties() {
        return {
          items:{
            type:Object,
          },
            searchText:{
                type:String,
                observer :'_searchTextChanged',
                notify: true
            },
            queryBody: {
                type: Object,
                value: function () {
                    return {
                        "query" : {  "match_all" : {} }
                    }
                }
            }
        };
      };

      _searchTextChanged (newValue) {
        this.search();
      }

      search() {
          console.log('Do Search text ', this.searchText);
          this.queryBody = this._createRequest(this.searchText);
      }

      _createRequest(searchText) {
          let request = {'query':{'match-all':{}}};
          if(searchText) {
              request={
                  'query':{
                      'simple_query_string':{
                            'fields':['app'],
                            'query': `${searchText}*`
                      }
                  }
              };
          };

          return request;
      }

      _handleResponse(e) {
          new Promise( (resolve, error) => {
              let response =  e.detail.response.hits;
              let total = response.total;
              let result = response.hits;
              let items = result.map( x => Object.assign( x._source, { id:x._id} ));
              resolve( items);
          }).then( items => {
              this.listData = items;
              return items;
          });
      }

    }

    window.customElements.define(DorySam.is, DorySam);
  </script>
</dom-module>
