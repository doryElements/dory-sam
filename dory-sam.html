<link rel="import" href="../polymer/polymer-element.html">

<link rel="import" href="../paper-fab/paper-fab.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../app-layout/app-layout.html">
<link rel="import" href="../app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-pages/iron-pages.html">

<link rel="import" href="dory-main-layout.html">
<link rel="import" href="dory-editor-layout.html">
<link rel="import" href="dory-sam-editor.html">
<link rel="import" href="dory-sam-list.html">
<link rel="import" href="dory-cruddy-event.html">
<link rel="import" href="dory-search-bar.html">

<dom-module id="dory-sam">
    <template>
        <style>
            :host {
                display: block;
            }

            h1{
                color: var(--h1-color);
                font : 40px "Roboto";
                margin-bottom : 5px;
            }

            paper-fab {
                right: 30px;
                bottom: 28px;
                position: fixed;
                --paper-fab-background: var(--primary-color);
            }

            .side{
                color:var(--sidebar-text-color);
                font : 16px Roboto;
                padding : 10px;
                margin-top: 50px;
            }

            .main-content{
                height : calc(100vh - 122px);
            }
        </style>

        <iron-ajax auto id="request" url="http://localhost:9200/sam/sam/_search?" handle-as="json"
            content-type="application/json" body="[[queryBody]]" method="post"
            on-response="_handleResponse"></iron-ajax>

        <iron-pages selected="[[tabSelected]]" fallback-selection="fallback">

            <!-- LISTE -->
            <dory-main-layout>
                <dory-search-bar id="searchBar"placeholder="Application" slot="sidebar" result="{{listData}}" search-text="{{searchText}}"></dory-search-bar>
                <div class="main-content" slot="content">
                    <dory-sam-list id="doryList" items="{{listData}}" entity-id="{{entityId}}"></dory-sam-list>
                    <paper-fab  icon="add-circle-outline" on-tap="_openEditorCreate"></paper-fab>
                </div>
            </dory-main-layout>

            <!-- EDITOR -->
            <dory-editor-layout id="edit">
                <dory-cruddy-event slot="editor">
                    <dory-sam-editor id="doryEditor" entity-id="{{entityId}}"></dory-sam-editor>
                </dory-cruddy-event>
            </dory-editor-layout>

            <!-- DETAILS VIEW -->
            <dory-main-layout>
                <div class="main-content" slot="content">
                    <dory-sam-card-details entity-id="[[entityId]]"></dory-sam-card-details>
                </div>
                <div  slot="sidebar" class="side" on-tap="_close">
                    <iron-icon icon="arrow-back"></iron-icon>
                    <label>Retour Ã  la liste</label>
                </div>
            </dory-main-layout>

        </iron-pages>
    </template>

    <script>
        /**
         * `dory-sam`
         *
         *
         * @customElement
         * @polymer
         * @demo demo/index.html
         */
        class DorySam extends Polymer.Element {
            static get is() { return 'dory-sam'; }

            ready() {
                super.ready();
                this.listData = new Array();
                this.$.doryList.addEventListener('dory-open-editor', e => this._handleEdit(e));
                this.$.doryList.addEventListener('dory-open-details', e => this._handleDetails(e));
                this.$.doryList.addEventListener('dory-load-data', e => this._loadMoreData(e));
                this.$.edit.addEventListener('editor-close', e => this._close(e));
                this.$.edit.addEventListener('editor-control', e => this.$.doryEditor._handleCommand(e.detail.command));
                this.$.searchBar.addEventListener('search',e => this._handleSearch(e));
                this.search();
            }

            static get properties() {
                return {
                    items:{
                        type:Object,
                    },
                    listData:{
                        type:Array,
                        value: () => {
                            return [];
                        }
                    },
                    listDataTotal:{
                        type: Number,
                        value : 0
                    },
                    searchText:{
                        type:String
                    },
                    queryFrom: {
                        type:Number,
                        value:0
                    },
                    querySize : {
                        type: Number,
                        value:10
                    },
                    queryBody: {
                        type: Object,
                        readonly: true
                    },
                    entityId : {
                        type : String
                    },
                    tabSelected : {
                        type: Number,
                        value : 0
                    }
                };
            };

            _handleEdit(e){
                let itemId = e.detail.id;
                this.entityId = itemId;
                this._openEditor();
            }
            _handleDetails(e){
                let itemId = e.detail.id;
                this.entityId = itemId;
                this.tabSelected=2;
            }
            _openEditorCreate(){
                this.entityId = null;

                this._openEditor();
            }
            _openEditor(){
                console.log('open editor');
                this.tabSelected = 1;
            }
            _close(){
                this.tabSelected = 0;
            }

            _handleSearch(e){
                this.listData=[];
                this.queryFrom=0;
                this.queryBody=this._createRequest(e.detail.searchText);
            }

            search() {
                this.queryBody = this._createRequest(this.searchText);
            }

            _createRequest(searchText) {
                let request = {
                    "query" : {"match_all" : {} },
                    "size": this.querySize,
                    "from": this.queryFrom
                };
                if(searchText) {
                    request={
                        'query':{
                            'simple_query_string':{
                                'fields':['app'],
                                'query': `${searchText}*`
                            }
                        }
                    };
                };
                console.log('_createRequest : ',  request);
                return request;
            }

            _handleResponse(e) {
                new Promise( (resolve, error) => {
                    const response =  e.detail.response.hits;
                    const result = response.hits;
                    const total = response.total;
                    const items = result.map( x => Object.assign( x._source, { id:x._id} ));
                    resolve( [items, total] );
                }).then( ([items, total]) => {
                    let newResult = [...this.listData, ...items];
                    this.listData = newResult;
                    console.log(total,this.listDataTotal);
                    if(total>this.listDataTotal){
                        this.listDataTotal = total;
                        this.$.doryList.clearTriggers();
                    }
                    else{
                        this.$.doryList.clearProgressBar();
                    }
                    return [items, total];
                });
            }

            _loadMoreData(){
                this.queryFrom += this.querySize;
                this.search();
            }
        }
        window.customElements.define(DorySam.is, DorySam);
    </script>
</dom-module>
