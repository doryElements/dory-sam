<link rel="import" href="../polymer/polymer.html">


<link rel="import" href="../paper-toolbar/paper-toolbar.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">

<link rel="import" href="../paper-fab/paper-fab.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-fab/paper-fab.html">

<link rel="import" href="../iron-ajax/iron-ajax.html">

<link rel="import" href="dory-sam-list.html">


<!--
`dory-sam-page-list`
Polymer Element dory-sam-page-list

@demo demo/index.html 
-->

<dom-module id="dory-sam-page-list">
    <template>
        <style>
            :host {
                display: block;
            }
            paper-fab {
                float: right;
                z-index: 10;
                right: 30px;
                top: 95px;
                position: relative;
                z-index: 10;
                --paper-fab-background: var(--paper-blue-100);
            }

        </style>
        <paper-toolbar class="medium-tall">
            <paper-icon-button id="button" icon="arrow-back"></paper-icon-button>
            <div class="title">Server Application Mapping</div>
            <paper-input value="{{searchText}}" placeholder="Search">
                <div prefix>>&nbsp</div>
                <paper-icon-button suffix icon="search" on-tap="search"></paper-icon-button>
            </paper-input>
            <paper-fab icon="add-circle-outline" on-tap="_requestEdit"></paper-fab>
        </paper-toolbar>


        <iron-ajax auto id="request" url="http://localhost:9200/sam/sam/_search" handle-as="json"
                   content-type="application/json" body="[[queryBody]]" method="post"
                   last-response="{{listData}}" on-response="_handleResponse"></iron-ajax>
        <template is="dom-if" if="[[dataloaded]]">
            <dory-sam-list  items="[[listData.hits.hits]]"></dory-sam-list>
        </template>
    </template>

    <script>
        Polymer({

            is: 'dory-sam-page-list',

            properties: {
                searchText: {
                    type:String,
                    observer: '_searchTextChanged',
                    notify: true
                },

                queryBody: {
                    type: Object,
                    value: function () {
                        return {
                            "query" : {  "match_all" : {} },
                            "aggs" : {
                                "env_count" : {
                                    "cardinality" : {
                                        "field" : "env",
                                        "missing": "N/A"
                                    }
                                }
                            }
                        }
                    }
                },
                dataloaded: {
                    type: Boolean,
                    value: false
                }
            },

            _searchTextChanged: function (newValue) {
                console.log('Search text ', newValue);
//                this.queryBody= this._createRequest(newValue);
            },
            search: function () {
                console.log('Do Search text ', this.searchText);
//                console.log(JSON.stringify(this.listData));
                this.queryBody= this._createRequest(this.searchText);
//                this.request
            },
            
            _createRequest: function (searchText) {
                var request ={"query" : {  "match_all" : {} }};
                if (searchText) {
                    request =  {
                        "query" : {
                            "term" : { "app" : this.searchText }
                        }
                    };
                };


                return request;
            },

            _requestEdit: function (entityId) {
                this.fire('dory-open-page', {page: 'edit', id: null});
            },
            _handleResponse: function(e){
                this.dataloaded = true;
            },

        });
    </script>
</dom-module>