<link rel="import" href="../polymer/polymer-element.html">

<script src="../d3/d3.min.js"></script>

<dom-module id="dory-d3-relationship-graph">
    <template>
        <style>
            :host {
                display: block;
            }

            .links line{
                stroke : #999;
                stroke-opacity : 0.6;
            }

            .nodes circle{
                stroke : #fff;
                stroke-width : 1px;
            }
        </style>

        <div id="svgcontainer" style$='width: [[width]]px; height: [[height]]px'></div>
        <!--<svg width="[[width]]" height="[[height]]"></svg>-->
    </template>

    <script>
        /**
         * `dory-d3-relationship-graph`
         *
         *
         * @customElement
         * @polymer
         * @demo demo/index.html
         */
        class DoryD3RelationshipGraph extends Polymer.Element {
            static get is() {
                return 'dory-d3-relationship-graph';
            }

            static get properties() {
                return {
                    data : {
                        type : Object,
                        value : {nodes:[{'name':'Travis','sex':'M'},
                                        {'name':'Rake','sex':'M'},
                                        {'name':'Diana','sex':'F'},
                                        {'name':'Rachel','sex':'F'},
                                        {'name':'Shawn','sex':'M'},
                                        {'name':'Emerald','sex':'F'}],
                                links:[{'source':'Travis','target':'Rake'},
                                        {'source':'Diana','target':'Rake'},
                                        {'source':'Diana','target':'Rachel'},
                                        {'source':'Rachel','target':'Rake'},
                                        {'source':'Rachel','target':'Shawn'},
                                        {'source':'Emerald','target':'Rachel'}]
                        }
                    },
                    width:{
                        type : Number,
                        value : 500
                    },
                    height:{
                        type:Number,
                        value : 500
                    },
                    margin:{
                        type:Number,
                        value : 10
                    }
                };
            }

            connectedCallback() {
                this.draw();
            }

            /**
             * Draw svg
             */
            draw(){
                const container = this.$.svgcontainer;

                let root = this.data;
                if(!root){
                    console.log('D3 : Pas de data');
                    return;
                }

                let svg = d3.select(container).append('svg')
                    .attr('width',this.width)
                    .attr('height',this.height);

                let simulation = d3.forceSimulation()
                    .nodes(this.data.nodes);

                simulation
                    .force('change_force',d3.forceManyBody())
                    .force('center_force',d3.forceCenter(this.width/2,this.height/2));

                let node = svg.append('g')
                    .attr('class','nodes')
                    .selectAll('circle')
                    .data(this.data.nodes)
                    .enter()
                    .append('circle')
                    .attr('r',5)
                    .attr('fill','red');

                let link_force = d3.forceLink(this.data.links).id(function(d){return d.name});

                simulation.force('links',link_force);

                let link = svg.append('g')
                    .attr('class','links')
                    .selectAll('line')
                    .data(this.data.links)
                    .enter().append('line')
                    .attr('stroke-width',2);

                simulation.on('tick',function(){
                    node
                        .attr('cx',function(d){return d.x;})
                        .attr('cy',function(d){return d.y;})
                    link
                        .attr('x1', function(d) {return d.source.x;})
                        .attr('y1', function(d) {return d.source.y;})
                        .attr('x2', function(d) {return d.target.x;})
                        .attr('y2', function(d) {return d.target.y;})
                });
            }
        }

        window.customElements.define(DoryD3RelationshipGraph.is, DoryD3RelationshipGraph);
    </script>
</dom-module>